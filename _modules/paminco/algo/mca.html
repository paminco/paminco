
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>paminco.algo.mca &#8212; paminco 0.1 documentation</title>
    
    <link href="../../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/pydata-sphinx-theme.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/contentui.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/paminco.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/user_guide.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/api.css" />
    
    <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/togglebutton.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../_static/contentui.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    
<a class="navbar-brand" href="../../../index.html">
<p class="title">paminco</p>
</a>

    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../getting_started.html">
  Getting Started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../user_guide/index.html">
  User Guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../api/index.html">
  API Reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../theory/index.html">
  Theoretical Background
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/paminco/paminco" rel="noopener" target="_blank" title="GitHub"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for paminco.algo.mca</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span> <span class="k">as</span> <span class="nn">sps</span>

<span class="kn">from</span> <span class="nn">.efa</span> <span class="kn">import</span> <span class="n">EFA</span><span class="p">,</span> <span class="n">EFAConfig</span><span class="p">,</span> <span class="n">EFAEdges</span><span class="p">,</span> <span class="n">NodePotentials</span>
<span class="kn">from</span> <span class="nn">paminco._base</span> <span class="kn">import</span> <span class="n">AlphaBetaApproximativeSolver</span><span class="p">,</span> <span class="n">ParametricSolution</span>
<span class="kn">from</span> <span class="nn">paminco.callback</span> <span class="kn">import</span> <span class="n">CallBackFlag</span>
<span class="kn">from</span> <span class="nn">paminco.net.network</span> <span class="kn">import</span> <span class="n">Network</span>
<span class="kn">from</span> <span class="nn">paminco.net.cost</span> <span class="kn">import</span> <span class="n">InterpolationRule</span><span class="p">,</span> <span class="n">PiecewiseQuadraticCoefficients</span><span class="p">,</span> <span class="n">PiecewiseQuadraticCost</span>
<span class="kn">from</span> <span class="nn">paminco.utils.bisec</span> <span class="kn">import</span> <span class="n">bisec_fast</span>
<span class="kn">from</span> <span class="nn">paminco.utils.misc</span> <span class="kn">import</span> <span class="n">callback_to_list</span>


<div class="viewcode-block" id="MCAInterpolationRule"><a class="viewcode-back" href="../../../api/algo/generated/paminco.algo.mca.MCAInterpolationRule.html#paminco.algo.mca.MCAInterpolationRule">[docs]</a><span class="k">class</span> <span class="nc">MCAInterpolationRule</span><span class="p">(</span><span class="n">InterpolationRule</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Breakpoint rule for MCA guaranteeing the :math:`(\alpha, \beta)`-approximation property.</span>
<span class="sd">    </span>
<span class="sd">    This class manages the the breakpoint computation for the interpolation</span>
<span class="sd">    of the cost functions in the Marginal Cost Approximation (MCA).</span>

<span class="sd">    The following assumptions on the cost functions :math:`F_e(x)` and the</span>
<span class="sd">    marginal costs :math:`f_e(x) := F&#39;_e(x)` must be satisfied.</span>

<span class="sd">    * :math:`F_e` is strictly convex and smooth.</span>
<span class="sd">    * For :math:`x \geq 0`, :math:`f_e&#39;&#39;(x)` is non-negative and non-decreasing</span>
<span class="sd">    * For :math:`x &lt; 0`, :math:`f_e&#39;&#39;(x)` is non-positive and non-increasing</span>

<span class="sd">    These properties are satisfied for functions of the form</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">        F_e(x) = a_e |x_e| x_e^{k-1} + b_e</span>

<span class="sd">    for :math:`k &gt; 3` and therefore apply for example to BPR functions for traffic networks</span>
<span class="sd">    or the activation functions typically used in the Weymouth equations in gas networks.</span>

<span class="sd">    The step sizes :math:`\delta_i` depending on :math:`x_i` that this rule computes, satisfy</span>
<span class="sd">    the inequality</span>

<span class="sd">    .. math::</span>
<span class="sd">        \delta_i B \leq 2 \sqrt{2} \sqrt{(\alpha-1) |f_e (x_i)| + \frac{\beta}{m x^{\max}}}</span>

<span class="sd">    where :math:`B = \sqrt{ \max \{ |f&#39;&#39;(x_i)|, |f&#39;&#39;(x_{i+1})| \} }`.</span>
<span class="sd">    The breakpoint rule always includes :math:`x=0` as breakpoint.</span>
<span class="sd">    The breakpoints are computed by solving the above inequality numerically up to a fixed</span>
<span class="sd">    precision given by the parameter ``accuracy``, while rounding to the safe side.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    alpha : float</span>
<span class="sd">        The parameter :math:`\alpha` for the relative approximation error of the MCA output</span>
<span class="sd">    beta : float</span>
<span class="sd">        The parameter :math:`\beta` for the absolute approximation error of the MCA output</span>
<span class="sd">    m : int</span>
<span class="sd">        The number of edges of the network the rule is applied to. Needed, since the absolute</span>
<span class="sd">        error of all edges is additive, in order to ensure an overall absolute error.</span>
<span class="sd">    x_max : float</span>
<span class="sd">        The (absolute value of the) maximum flow value on one edge, or a bound on that value.</span>
<span class="sd">        An estimate on this value could be</span>
<span class="sd">        :math:`x^{\max} := \lambda^{\max} \frac{1}{2} \sum_{v \in V} |b_v|`.</span>
<span class="sd">    accuracy : float, default=1e-05</span>
<span class="sd">        The accuracy for the numerical solution of the breakpoint inequality.</span>

<span class="sd">    See also</span>
<span class="sd">    --------</span>
<span class="sd">    paminco.network.cost.NetworkCostInterpolation</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MCAInterpolationRule.__init__"><a class="viewcode-back" href="../../../api/algo/generated/paminco.algo.mca.MCAInterpolationRule.html#paminco.algo.mca.MCAInterpolationRule.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">x_max</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="n">accuracy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-5</span>
            <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">=</span> <span class="n">x_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy</span></div>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">edge_cost</span><span class="p">,</span>
            <span class="n">edge</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">x</span><span class="p">:</span> <span class="nb">float</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Compute the next breakpoint :math:`\delta` by solving the inequality</span>
<span class="sd">        </span>
<span class="sd">        .. math::</span>
<span class="sd">            \delta B \leq 2 \sqrt{2} \sqrt{(\alpha-1) |f_e (x)| + \frac{\beta}{m x^{\max}}}</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        edge_cost: EdgeCost</span>
<span class="sd">            The :class:`~paminco.net.cost.EdgeCost` object representing the edge cost function</span>
<span class="sd">            :math:`F(x)`.</span>
<span class="sd">        edge: int</span>
<span class="sd">            The index of the edge. Only for debugging purposes, can also be None.</span>
<span class="sd">        x: float</span>
<span class="sd">            The last breakpoint.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        delta: float</span>
<span class="sd">            The step size :math:`\delta` to the next breakpoint.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">edge_cost</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">f2</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">edge_cost</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        
        <span class="c1"># If the cost that are interpolated are polynomials</span>
        <span class="c1"># and the degree of the polynomial is less or equal 2</span>
        <span class="c1"># than no interpolation is needed =&gt; return infinite</span>
        <span class="c1"># step size</span>
        <span class="k">if</span> <span class="n">edge_cost</span><span class="o">.</span><span class="n">degree</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        
        <span class="n">y1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">f2atx</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">f2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">fixed_rhs_val</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">err_fct</span><span class="p">(</span><span class="n">delta</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">y2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">delta</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            
            <span class="n">rhs_val</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
            <span class="n">rhs_val</span> <span class="o">+=</span> <span class="n">fixed_rhs_val</span>
            
            <span class="n">mcost2val</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">f2</span><span class="p">(</span><span class="n">delta</span> <span class="o">+</span> <span class="n">x</span><span class="p">))</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">f2atx</span>
            <span class="k">return</span> <span class="n">delta</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mcost2val</span> <span class="o">-</span> <span class="n">rhs_val</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">bisec_fast</span><span class="p">(</span><span class="n">err_fct</span><span class="p">,</span>
                               <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">accuracy</span><span class="p">,</span>
                               <span class="n">up</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                               <span class="n">exclude_lo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">val_constr</span><span class="o">=</span><span class="s1">&#39;npos&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Breakpoint at 0 is required since the breakpoint</span>
        <span class="c1"># computation rule differs for negative and</span>
        <span class="c1"># positive values of x</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">+</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span>
        
        <span class="k">return</span> <span class="n">delta</span></div>


<div class="viewcode-block" id="MCAConfig"><a class="viewcode-back" href="../../../api/algo/generated/paminco.algo.mca.MCAConfig.html#paminco.algo.mca.MCAConfig">[docs]</a><span class="k">class</span> <span class="nc">MCAConfig</span><span class="p">(</span><span class="n">EFAConfig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Settings for MCA algorithms.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    alpha : float, default=1.01</span>
<span class="sd">        Relative tolerance for alpha-beta-approximation.</span>
<span class="sd">    beta : float, default=1</span>
<span class="sd">        Absolute tolerance for alpha-beta-approximation.</span>
<span class="sd">    interpolation_accuracy : float, default=1e-3</span>
<span class="sd">        # TODO-PW</span>
<span class="sd">    interpolation_step_size, optional</span>
<span class="sd">        # TODO-PW</span>
<span class="sd">    lambda_max : float, default=1</span>
<span class="sd">        Maxmimum parameter (lambda) to find *minimum cost flow* for.</span>
<span class="sd">    inverse_method : str, int or InverseMethod, default=InverseMethod.CHOLESKY</span>
<span class="sd">        Method to find the inverse Laplacian.</span>
<span class="sd">    pivot_mode : int, str or PivotStepMode, default=PivotStepMode.LEX</span>
<span class="sd">        Method to choose min edge if len(boundary_edges) &gt; 1.</span>
<span class="sd">    max_iter : int, default=99999</span>
<span class="sd">        Maximum number of iterations for solver.</span>
<span class="sd">    print : bool, default=False</span>
<span class="sd">        Whether to print a summary of each iteration.</span>
<span class="sd">    recomp_interval : int, default=1</span>
<span class="sd">        If &lt;= 1, recompute inverse Laplacian in every iteration. Else</span>
<span class="sd">        update and recompute every `recomp_interval`. The higher the</span>
<span class="sd">        value, the less accurate the inverse Laplacian.</span>
<span class="sd">    round_lambda : int, default=3</span>
<span class="sd">        Round lambda value for edges to `round_lambda` after decimal.</span>
<span class="sd">        Used to determine boundary edges.</span>
<span class="sd">    rounding_margins_base : int, default=-16</span>
<span class="sd">        Set gamma_dpi with low exponent (in `IEEE754 &lt;https://en.wikipedia.org/wiki/IEEE_754&gt;`_) to zero.</span>
<span class="sd">    rounding_margins_fac : int, default=-5</span>
<span class="sd">        Set gamma_dpi with low exponent (in `IEEE754 &lt;https://en.wikipedia.org/wiki/IEEE_754&gt;`_) to zero.</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">kw_init</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;lambda_max&quot;</span><span class="p">,</span>
        <span class="s2">&quot;alpha&quot;</span><span class="p">,</span>
        <span class="s2">&quot;beta&quot;</span><span class="p">,</span>
        <span class="s2">&quot;interpolation_step_size&quot;</span><span class="p">,</span>
        <span class="s2">&quot;interpolation_accuracy&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    
<div class="viewcode-block" id="MCAConfig.__init__"><a class="viewcode-back" href="../../../api/algo/generated/paminco.algo.mca.MCAConfig.html#paminco.algo.mca.MCAConfig.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.01</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpolation_accuracy</span> <span class="o">=</span> <span class="mf">1e-3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpolation_step_size</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># ? TODO-PW: alpha-beta approxim for equation check in interpolation instead of abs difference</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">map_kwargs</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    
    <span class="k">def</span> <span class="nf">get_efa_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">EFAConfig</span><span class="o">.</span><span class="n">all_options</span><span class="p">}</span></div>


<div class="viewcode-block" id="MCA"><a class="viewcode-back" href="../../../api/algo/mca.html#paminco.algo.mca.MCA">[docs]</a><span class="k">class</span> <span class="nc">MCA</span><span class="p">(</span><span class="n">AlphaBetaApproximativeSolver</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Marginal Cost Approximation.</span>
<span class="sd">    </span>
<span class="sd">    This method interpolates the marginal edge cost and then runs EFA to</span>
<span class="sd">    compute an exact optimal potential (and thus minimum cost flow) function.</span>
<span class="sd">    Thus, MCA is an approximate solver, where the approximation error arises</span>
<span class="sd">    from the spline-interpolation, and is named as marginal cost approximation</span>
<span class="sd">    (MCA).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    net : Network</span>
<span class="sd">        Network to find parametric min cost flows for.</span>
<span class="sd">    name : str, optional</span>
<span class="sd">        Name of solver.</span>
<span class="sd">    callback : callable, or list of callable, optional</span>
<span class="sd">        Callbacks called during initialization and run method. Can be</span>
<span class="sd">        used for debugging and timing.</span>
<span class="sd">    use_simple_timer : bool, default=True</span>
<span class="sd">        Whether to time MCA. If ``True``, timestamps for intializtion</span>
<span class="sd">        and every iteration will be saved to attribute ``timer``.</span>
<span class="sd">    kwargs : keyword arguments, optional</span>
<span class="sd">        Further options for MCA, see MCFIConfig.</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    region</span>
<span class="sd">    edges</span>
<span class="sd">    edge_coeffs</span>
<span class="sd">    node_potentials</span>
<span class="sd">    </span>
<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    MCAConfig: Settings for MCA.</span>
<span class="sd">    MCAInterpolationRule : Piecewise linear interpolation of the edge cost.</span>
<span class="sd">    paminco.algo.efa.EFA:</span>
<span class="sd">        Electrical flow algorithm to be run on modified network with piecewise</span>
<span class="sd">        quadratic cost.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [Kli21] Klimm, Max, and P. Warode. &quot;Parametric Computation of Minimum Cost</span>
<span class="sd">           Flows with Piecewise Quadratic Costs.&quot; Mathematics of Operations</span>
<span class="sd">           Research (2021). Available 10/25/2021 at https://www3.math.tu-berlin.de/disco/research/publications/pdf/KlimmWarode2021.pdf</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------   </span>
<span class="sd">    SiouxFalls: a parametric Price of Anarchy::</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; import copy</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">        &gt;&gt;&gt; import paminco</span>
<span class="sd">        &gt;&gt;&gt; sioux = paminco.load_sioux()</span>
<span class="sd">        &gt;&gt;&gt; sioux.set_demand((&quot;20&quot;, &quot;3&quot;, 100000))</span>
<span class="sd">        &gt;&gt;&gt; # --- Run MCA for user equilibrium</span>
<span class="sd">        &gt;&gt;&gt; sioux_ue = copy.deepcopy(sioux)</span>
<span class="sd">        &gt;&gt;&gt; sioux_ue.cost.integrate(inplace=True)</span>
<span class="sd">        &gt;&gt;&gt; mca_ue = paminco.MCA(sioux_ue)</span>
<span class="sd">        &gt;&gt;&gt; mca_ue.run()</span>
<span class="sd">        &gt;&gt;&gt; # --- Run MCA for system optimum</span>
<span class="sd">        &gt;&gt;&gt; sioux_so = copy.deepcopy(sioux) </span>
<span class="sd">        &gt;&gt;&gt; sioux_so.cost.times_x(inplace=True)</span>
<span class="sd">        &gt;&gt;&gt; mca_so = paminco.MCA(sioux_so)</span>
<span class="sd">        &gt;&gt;&gt; mca_so.run()</span>
<span class="sd">        &gt;&gt;&gt; # compute POA</span>
<span class="sd">        &gt;&gt;&gt; def TTST(x):</span>
<span class="sd">        ...   return sioux_so.cost.F(x).sum()</span>
<span class="sd">        &gt;&gt;&gt; lambdas = np.linspace(1e-5, 1, 100)</span>
<span class="sd">        &gt;&gt;&gt; cost_ue = np.array([TTST(mca_ue.flow_at(l)) for l in lambdas])</span>
<span class="sd">        &gt;&gt;&gt; cost_so = np.array([TTST(mca_so.flow_at(l)) for l in lambdas])</span>
<span class="sd">        &gt;&gt;&gt; poa = cost_ue / cost_so</span>
<span class="sd">    </span>
<span class="sd">    Determine edge flow in user equilibrium as a function of demand factor::</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">        &gt;&gt;&gt; import paminco</span>
<span class="sd">        &gt;&gt;&gt; net = paminco.net.load_sioux()</span>
<span class="sd">        &gt;&gt;&gt; net.integrate_cost()</span>
<span class="sd">        &gt;&gt;&gt; net.set_demand((&quot;2&quot;, &quot;21&quot;, 100000))</span>
<span class="sd">        &gt;&gt;&gt; mca = paminco.MCA(net)</span>
<span class="sd">        &gt;&gt;&gt; mca.run()</span>
<span class="sd">        &gt;&gt;&gt; mca.plot_flow_on_edge(55): #doctest: +SKIP</span>
<span class="sd">        </span>
<span class="sd">    Parametric natural gas flows::</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; import matplotlib.pyplot as plt</span>
<span class="sd">        &gt;&gt;&gt; import paminco</span>
<span class="sd">        &gt;&gt;&gt; net = paminco.net.load_gas(&quot;gas24&quot;)</span>
<span class="sd">        &gt;&gt;&gt; net.size</span>
<span class="sd">        (18, 19, 1)</span>
<span class="sd">        &gt;&gt;&gt; net.cost.integrate(inplace=True)</span>
<span class="sd">        &gt;&gt;&gt; demand_dir = (&quot;entry03&quot;, &quot;exit05&quot;, abs(net.demand()).sum())</span>
<span class="sd">        &gt;&gt;&gt; net.set_demand((net.demand.b, demand_dir), mode=&quot;affine&quot;)</span>
<span class="sd">        &gt;&gt;&gt; mca = paminco.MCA(net)</span>
<span class="sd">        &gt;&gt;&gt; mca.run()</span>
<span class="sd">        &gt;&gt;&gt; fig, (ax0, ax1) = plt.subplots(nrows=1, ncols=2, sharex=True, figsize=(12, 4))</span>
<span class="sd">        &gt;&gt;&gt; d = {5: ax0, 8:ax1}</span>
<span class="sd">        &gt;&gt;&gt; for edge, ax in d.items():</span>
<span class="sd">        ...     mca.plot_flow_on_edge(edge, ax=ax) #doctest: +SKIP</span>
<span class="sd">        ...     ax.set_xlabel(&quot;$\lambda$&quot;)</span>
<span class="sd">        ...     ax.set_ylabel(&quot;flow&quot;)</span>
<span class="sd">        ...     ax.set_title(f&quot;Parametric gasflow for edge {edge}&quot;)</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">network</span><span class="p">:</span> <span class="n">Network</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">use_simple_timer</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">copy_network</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">network</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span>
            <span class="n">copy_network</span><span class="o">=</span><span class="n">copy_network</span><span class="p">,</span>
            <span class="n">use_simple_timer</span><span class="o">=</span><span class="n">use_simple_timer</span>
        <span class="p">)</span>
        <span class="c1"># MCA settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_c</span> <span class="o">=</span> <span class="n">MCAConfig</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="c1"># Prepare network be run with EFA</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cost_to_piecewise</span><span class="p">()</span>
        
        <span class="c1"># Pass prepped network to EFA</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">efa</span> <span class="o">=</span> <span class="n">EFA</span><span class="p">(</span>
            <span class="n">network</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
            <span class="n">copy_network</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">preprocess_network</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">use_simple_timer</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">get_efa_kwargs</span><span class="p">()</span>
        <span class="p">)</span>
        
        <span class="c1"># Flag end of iteration to listeners</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">CallBackFlag</span><span class="o">.</span><span class="n">INIT_END</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_cost_to_piecewise</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Initialize network costs if not PiecewiseQuadraticCost</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_net</span><span class="o">.</span><span class="n">cost</span><span class="p">,</span> <span class="n">PiecewiseQuadraticCost</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># Get maximum value for which to egde cost splines</span>
            <span class="n">x_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_net</span><span class="o">.</span><span class="n">_d</span><span class="o">.</span><span class="n">max_inflow</span><span class="p">(</span><span class="n">max_param</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_c</span><span class="o">.</span><span class="n">lambda_max</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            
            <span class="c1"># Transform edge cost to piecewise quadratic</span>
            <span class="n">iprule</span> <span class="o">=</span> <span class="n">MCAInterpolationRule</span><span class="p">(</span>
                <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
                <span class="n">beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
                <span class="n">m</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
                <span class="n">x_max</span><span class="o">=</span><span class="n">x_max</span><span class="p">,</span>
                <span class="n">accuracy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">interpolation_accuracy</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_net</span><span class="o">.</span><span class="n">_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_net</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">iprule</span><span class="p">)</span>
    
<div class="viewcode-block" id="MCA.run"><a class="viewcode-back" href="../../../api/algo/generated/paminco.algo.mca.MCA.run.html#paminco.algo.mca.MCA.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
            <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">+</span> <span class="n">callback_to_list</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">efa</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">i</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current iteration count.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">efa</span><span class="o">.</span><span class="n">i</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lambda_min</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current lambda_min.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">efa</span><span class="o">.</span><span class="n">lambda_min</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lambda_max</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current lambda_max.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">efa</span><span class="o">.</span><span class="n">lambda_max</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">breakflag</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get current breakflag value.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">efa</span><span class="o">.</span><span class="n">breakflag</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">region</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">efa</span><span class="o">.</span><span class="n">region</span>
    
    <span class="n">region</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">EFA</span><span class="o">.</span><span class="n">region</span><span class="o">.</span><span class="vm">__doc__</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">edges</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EFAEdges</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">efa</span><span class="o">.</span><span class="n">edges</span>
    
    <span class="n">edges</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">EFA</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="vm">__doc__</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">edge_coeffs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PiecewiseQuadraticCoefficients</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">efa</span><span class="o">.</span><span class="n">edge_coeffs</span>
    
    <span class="n">edge_coeffs</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">EFA</span><span class="o">.</span><span class="n">edge_coeffs</span><span class="o">.</span><span class="vm">__doc__</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">node_potentials</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NodePotentials</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">efa</span><span class="o">.</span><span class="n">node_potentials</span>
    
    <span class="n">node_potentials</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">EFA</span><span class="o">.</span><span class="n">node_potentials</span><span class="o">.</span><span class="vm">__doc__</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">param_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ParametricSolution</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">efa</span><span class="o">.</span><span class="n">param_solution</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">L0</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sps</span><span class="o">.</span><span class="n">spmatrix</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">efa</span><span class="o">.</span><span class="n">L0</span>
    
    <span class="n">L0</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">EFA</span><span class="o">.</span><span class="n">L0</span><span class="o">.</span><span class="vm">__doc__</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">region_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">efa</span><span class="o">.</span><span class="n">region_zero</span>
    
    <span class="n">region_zero</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">EFA</span><span class="o">.</span><span class="n">region_zero</span><span class="o">.</span><span class="vm">__doc__</span></div>
</pre></div>

              </div>
              
              
          </main>
          

      </div>
    </div>
  
    <script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2021, Per Joachims, Max Klimm, Philipp Warode.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>